# ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç”¨Makefile

# ãƒ­ãƒ¼ã‚«ãƒ«IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è‡ªå‹•å–å¾—
LOCAL_IP := $(shell route -n get default | grep interface | awk '{print $$2}' | xargs ifconfig | grep "inet " | head -1 | awk '{print $$2}')

.PHONY: env disable-google-services enable-google-services build-ios-dev build-android-dev build-ios-prd submit-ios help

# .env.localãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆï¼ˆãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç”¨ï¼‰
env:
	@echo "ğŸ”§ .env.localãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªä¸­..."
	@if [ -f .env.local ]; then \
		echo "ğŸ“„ æ—¢å­˜ã®.env.localãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚"; \
		echo "ğŸ“ ç¾åœ¨ã®è¨­å®š:"; \
		cat .env.local; \
		echo ""; \
		echo "ğŸ”„ ã‚µãƒ¼ãƒãƒ¼è¨­å®šã‚’ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ä¸Šæ›¸ãä¸­..."; \
		sed -i '' 's/^EXPO_PUBLIC_SERVER_IP=.*/EXPO_PUBLIC_SERVER_IP=$(LOCAL_IP)/' .env.local; \
		echo "âœ… ã‚µãƒ¼ãƒãƒ¼è¨­å®šãŒä¸Šæ›¸ãã•ã‚Œã¾ã—ãŸ:"; \
		cat .env.local; \
	else \
		echo "ğŸ“„ æ–°ã—ã„.env.localãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆä¸­..."; \
		echo "EXPO_PUBLIC_SERVER_IP=$(LOCAL_IP)" > .env.local; \
		echo "âœ… .env.localãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸ:"; \
		cat .env.local; \
	fi

# .gitignoreã®GoogleService-Info.plistã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼ˆãƒ“ãƒ«ãƒ‰ã«å«ã‚ã‚‹ï¼‰
enable-google-services:
	@echo "ğŸ”§ GoogleService-Info.plistã‚’ãƒ“ãƒ«ãƒ‰ã«å«ã‚ã‚‹ãŸã‚.gitignoreã‚’ä¸€æ™‚çš„ã«ä¿®æ­£ä¸­..."
	@if grep -q "^\*\*/\*\.plist" .gitignore; then \
		sed -i '' 's/^\*\*\/\*\.plist/#**\/*.plist/' .gitignore; \
		echo "âœ… .gitignoreã®**/*.plistã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ"; \
	else \
		echo "âœ… æ—¢ã«**/*.plistã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆæ¸ˆã¿ã§ã™"; \
	fi
	@if grep -q "^\*\*/google-services\.json" .gitignore; then \
		sed -i '' 's/^\*\*\/google-services\.json/#**\/google-services.json/' .gitignore; \
		echo "âœ… .gitignoreã®**/google-services.jsonã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ"; \
	else \
		echo "âœ… æ—¢ã«**/google-services.jsonã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆæ¸ˆã¿ã§ã™"; \
	fi

# .gitignoreã®GoogleService-Info.plistã®ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã‚’è§£é™¤ï¼ˆå…ƒã«æˆ»ã™ï¼‰
disable-google-services:
	@echo "ğŸ”§ .gitignoreã‚’å…ƒã«æˆ»ã—ã¦ã„ã¾ã™..."
	@if grep -q "^#\*\*/\*\.plist" .gitignore; then \
		sed -i '' 's/^#\*\*\/\*\.plist/**\/*.plist/' .gitignore; \
		echo "âœ… .gitignoreã®**/*.plistã®ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã‚’è§£é™¤ã—ã¾ã—ãŸ"; \
	else \
		echo "âœ… æ—¢ã«**/*.plistã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“"; \
	fi
	@if grep -q "^#\*\*/google-services\.json" .gitignore; then \
		sed -i '' 's/^#\*\*\/google-services\.json/**\/google-services.json/' .gitignore; \
		echo "âœ… .gitignoreã®**/google-services.jsonã®ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã‚’è§£é™¤ã—ã¾ã—ãŸ"; \
	else \
		echo "âœ… æ—¢ã«**/google-services.jsonã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“"; \
	fi

# EAS Buildã‚³ãƒãƒ³ãƒ‰ï¼ˆGoogleService-Info.plistã‚’è‡ªå‹•ã§å«ã‚ã‚‹ï¼‰
build-ios-dev:
	@echo "ğŸ iOS Development Buildã‚’ä½œæˆä¸­..."
	@$(MAKE) enable-google-services
	@echo "ğŸ“± GoogleService-Info.plistã‚’ãƒ“ãƒ«ãƒ‰ã«å«ã‚ã¦ãƒ“ãƒ«ãƒ‰é–‹å§‹..."
	@eas build --platform ios --profile development-device || (echo "âŒ ãƒ“ãƒ«ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚.gitignoreã‚’å…ƒã«æˆ»ã—ã¾ã™..." && $(MAKE) disable-google-services && exit 1)
	@$(MAKE) disable-google-services
	@echo "âœ… ãƒ“ãƒ«ãƒ‰å®Œäº†ï¼.gitignoreã‚’å…ƒã«æˆ»ã—ã¾ã—ãŸ"

build-android-dev:
	@echo "ğŸ¤– Android Development Buildã‚’ä½œæˆä¸­..."
	@$(MAKE) enable-google-services
	@echo "ğŸ“± GoogleService-Info.plistã‚’ãƒ“ãƒ«ãƒ‰ã«å«ã‚ã¦ãƒ“ãƒ«ãƒ‰é–‹å§‹..."
	@eas build --platform android --profile development-device || (echo "âŒ ãƒ“ãƒ«ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚.gitignoreã‚’å…ƒã«æˆ»ã—ã¾ã™..." && $(MAKE) disable-google-services && exit 1)
	@$(MAKE) disable-google-services
	@echo "âœ… ãƒ“ãƒ«ãƒ‰å®Œäº†ï¼.gitignoreã‚’å…ƒã«æˆ»ã—ã¾ã—ãŸ"

build-ios-preview:
	@echo "ğŸ iOS Preview Buildã‚’ä½œæˆä¸­..."
	@$(MAKE) enable-google-services
	@echo "ğŸ“± GoogleService-Info.plistã‚’ãƒ“ãƒ«ãƒ‰ã«å«ã‚ã¦ãƒ“ãƒ«ãƒ‰é–‹å§‹..."
	@eas build --platform ios --profile preview || (echo "âŒ ãƒ“ãƒ«ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚.gitignoreã‚’å…ƒã«æˆ»ã—ã¾ã™..." && $(MAKE) disable-google-services && exit 1)
	@$(MAKE) disable-google-services
	@echo "âœ… ãƒ“ãƒ«ãƒ‰å®Œäº†ï¼.gitignoreã‚’å…ƒã«æˆ»ã—ã¾ã—ãŸ"

build-android-preview:
	@echo "ğŸ¤– Android Preview Buildã‚’ä½œæˆä¸­..."
	@$(MAKE) enable-google-services
	@echo "ğŸ“± GoogleService-Info.plistã‚’ãƒ“ãƒ«ãƒ‰ã«å«ã‚ã¦ãƒ“ãƒ«ãƒ‰é–‹å§‹..."
	@eas build --platform android --profile preview || (echo "âŒ ãƒ“ãƒ«ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚.gitignoreã‚’å…ƒã«æˆ»ã—ã¾ã™..." && $(MAKE) disable-google-services && exit 1)
	@$(MAKE) disable-google-services
	@echo "âœ… ãƒ“ãƒ«ãƒ‰å®Œäº†ï¼.gitignoreã‚’å…ƒã«æˆ»ã—ã¾ã—ãŸ"

build-ios-prd:
	@echo "ğŸ iOS Production Buildã‚’ä½œæˆä¸­..."
	@$(MAKE) enable-google-services
	@echo "ğŸ“± GoogleService-Info.plistã‚’ãƒ“ãƒ«ãƒ‰ã«å«ã‚ã¦ãƒ“ãƒ«ãƒ‰é–‹å§‹..."
	@eas build --platform ios --profile production || (echo "âŒ ãƒ“ãƒ«ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚.gitignoreã‚’å…ƒã«æˆ»ã—ã¾ã™..." && $(MAKE) disable-google-services && exit 1)
	@$(MAKE) disable-google-services
	@echo "âœ… ãƒ“ãƒ«ãƒ‰å®Œäº†ï¼.gitignoreã‚’å…ƒã«æˆ»ã—ã¾ã—ãŸ"

submit-ios:
	@echo "ğŸ iOS Production Buildã‚’é€ä¿¡ä¸­..."
	eas submit --platform ios --profile production

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
help:
	@echo "åˆ©ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰:"
	@echo "  make env            - .env.localãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª/ç”Ÿæˆï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼è¨­å®šï¼‰"
	@echo ""
	@echo "EAS Buildï¼ˆã‚¯ãƒ©ã‚¦ãƒ‰ä¸Šã§ãƒ“ãƒ«ãƒ‰ã€GoogleService-Info.plistã‚’è‡ªå‹•ã§å«ã‚ã‚‹ï¼‰:"
	@echo "  make build-ios-dev    - iOS Development Buildä½œæˆ"
	@echo "  make build-android-dev - Android Development Buildä½œæˆ"
	@echo "  make build-ios-preview - iOS Preview Buildä½œæˆ"
	@echo "  make build-android-preview - Android Preview Buildä½œæˆ"
	@echo "  make build-ios-prd    - iOS Production Buildä½œæˆ"
	@echo "  make submit-ios       - iOS Production Buildé€ä¿¡"
	@echo ""
	@echo "æ‰‹å‹•æ“ä½œ:"
	@echo "  make enable-google-services  - .gitignoreã®**/*.plistã¨**/google-services.jsonã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ"
	@echo "  make disable-google-services - .gitignoreã®**/*.plistã¨**/google-services.jsonã®ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã‚’è§£é™¤"
	@echo ""
	@echo "ç’°å¢ƒå¤‰æ•°:"
	@echo "  LOCAL_IP        - è‡ªå‹•å–å¾—ã•ã‚ŒãŸãƒ­ãƒ¼ã‚«ãƒ«IP: $(LOCAL_IP)"
